' === Gère les modifications dans la feuille (colonne Q : date, ou P : couleur) ===
Private Sub Worksheet_Change(ByVal Target As Range)

    ' Colonnes concernées
    Const COL_DATE_Q As Long = 17       ' Colonne Q = date de l'événement
    Const COL_COULEUR_Q As Long = 16    ' Colonne P = couleur associée à l'événement
    Const HEADER_ROW As Long = 5        ' Ligne d’en-tête avec les dates du planning
    Const START_COL As Long = 22        ' Colonne V = début des colonnes planning

    ' On ignore si plusieurs cellules sont modifiées à la fois
    If Target.Cells.Count > 1 Then Exit Sub

    On Error GoTo Fin
    Application.EnableEvents = False

    ' Si la modification touche la colonne Q (date) ou P (couleur), on agit
    If Target.Column = COL_DATE_Q Or Target.Column = COL_COULEUR_Q Then

        ' Récupération de la date (Q) et de la couleur (P) sur la ligne modifiée
        Dim laDateQ As Variant, laCouleurQ As Long, laOldDateQ As Variant
        laDateQ = Me.Cells(Target.Row, COL_DATE_Q).Value
        laCouleurQ = Me.Cells(Target.Row, COL_COULEUR_Q).Interior.Color

        ' Variables statiques pour mémoriser l’ancienne date et ligne
        Static OldDateQ As Variant
        Static OldRow As Long

        Debug.Print "==> Worksheet_Change : Modification ligne " & Target.Row & ", col " & Target.Column
        Debug.Print "    Nouvelle valeur Q = [" & laDateQ & "], Couleur = " & laCouleurQ

        ' Si la nouvelle date est invalide, on efface la couleur précédente
        If Not IsDate(laDateQ) Then
            If Not IsEmpty(OldDateQ) And OldRow = Target.Row Then
                Debug.Print "    Effacement couleur case planning pour ancienne date Q : " & OldDateQ
                Call EnleveCouleurCaseDate(Me, Target.Row, HEADER_ROW, START_COL, OldDateQ)
            End If
        Else
            ' Si la date a changé, on efface l’ancienne et on applique la nouvelle couleur
            If Not IsEmpty(OldDateQ) And OldRow = Target.Row And OldDateQ <> laDateQ Then
                Debug.Print "    Changement de date Q : efface ancienne case " & OldDateQ
                Call EnleveCouleurCaseDate(Me, Target.Row, HEADER_ROW, START_COL, OldDateQ)
            End If

            Debug.Print "    Coloriage nouvelle case planning pour date Q : " & laDateQ
            Call ColorieCaseQ(Me, Target.Row, HEADER_ROW, START_COL, laDateQ, laCouleurQ)
        End If

        ' On mémorise cette date et cette ligne pour la suite
        OldDateQ = laDateQ
        OldRow = Target.Row
    End If

Fin:
    Application.EnableEvents = True
End Sub

' === Colore la case du planning correspondant à la date Q (colonne Q) ===
Public Sub ColorieCaseQ(ws As Worksheet, ByVal srcRow As Long, ByVal HEADER_ROW As Long, ByVal START_COL_INIT As Long, ByVal dateQ As Variant, ByVal couleurQ As Long)
    Dim lastCol As Long, i As Long
    lastCol = ws.Columns.Count

    ' On adapte le décalage pour certaines feuilles spécifiques
    Dim START_COL As Long
    If ws.Name = "PLANNING METRE ET GEOMETRE" Then
        START_COL = START_COL_INIT + 2
    Else
        START_COL = START_COL_INIT
    End If

    ' On parcourt la ligne d'en-tête pour trouver la colonne de la date cible
    If IsDate(dateQ) Then
        For i = START_COL To lastCol
            If IsDate(ws.Cells(HEADER_ROW, i).Value) Then
                If ws.Cells(HEADER_ROW, i).Value = dateQ Then
                    Debug.Print "      ColorieCaseQ : Colore (" & srcRow & "," & i & ") couleur " & couleurQ
                    ws.Cells(srcRow, i).Interior.Color = couleurQ
                    Exit For
                End If
            End If
        Next i
    End If
End Sub

' === Efface la couleur sur une date précise du planning (ancienne date Q) ===
Public Sub EnleveCouleurCaseDate(ws As Worksheet, ByVal srcRow As Long, ByVal HEADER_ROW As Long, ByVal START_COL_INIT As Long, ByVal dateQ As Variant)
    Dim lastCol As Long, i As Long
    lastCol = ws.Columns.Count

    ' Déterminer le point de départ selon la feuille
    Dim START_COL As Long
    If ws.Name = "PLANNING METRE ET GEOMETRE" Then
        START_COL = START_COL_INIT + 2
    Else
        START_COL = START_COL_INIT
    End If

    ' Parcours pour effacer la couleur sur la bonne date
    If IsDate(dateQ) Then
        For i = START_COL To lastCol
            If IsDate(ws.Cells(HEADER_ROW, i).Value) Then
                If ws.Cells(HEADER_ROW, i).Value = dateQ Then
                    Debug.Print "      EnleveCouleurCaseDate : Efface (" & srcRow & "," & i & ")"
                    ws.Cells(srcRow, i).Interior.ColorIndex = xlColorIndexNone
                    Exit For
                End If
            End If
        Next i
    End If
End Sub

' === Colore la cellule du planning en fonction d’une date et d’une couleur données ===
Public Sub ColorieCasePlanning(ws As Worksheet, ByVal srcRow As Long, ByVal dateAffaire As Variant, ByVal coulAffaire As Long, ByVal HEADER_ROW As Long, ByVal START_COL_INIT As Long)
    Dim lastCol As Long, i As Long
    lastCol = ws.Columns.Count

    ' Ajustement du point de départ selon la feuille
    Dim START_COL As Long
    If ws.Name = "PLANNING METRE ET GEOMETRE" Then
        START_COL = START_COL_INIT + 2
    Else
        START_COL = START_COL_INIT
    End If

    Debug.Print "--- ColorieCasePlanning ---"
    Debug.Print "  Feuille : " & ws.Name
    Debug.Print "  Ligne = " & srcRow & ", HEADER_ROW = " & HEADER_ROW & ", START_COL = " & START_COL & ", lastCol = " & lastCol
    Debug.Print "  dateAffaire = [" & dateAffaire & "] (type=" & TypeName(dateAffaire) & "), coulAffaire = " & coulAffaire

    ' Étape 1 : on efface d'abord toute la ligne planning
    For i = START_COL To lastCol
        ws.Cells(srcRow, i).Interior.ColorIndex = xlColorIndexNone
    Next i

    ' Étape 2 : si une date est valide, on la cherche dans l’en-tête pour appliquer la couleur
    If IsDate(dateAffaire) Then
        Dim trouve As Boolean: trouve = False
        For i = START_COL To lastCol
            If IsDate(ws.Cells(HEADER_ROW, i).Value) Then
                If Day(ws.Cells(HEADER_ROW, i).Value) = Day(dateAffaire) And _
                   Month(ws.Cells(HEADER_ROW, i).Value) = Month(dateAffaire) And _
                   Year(ws.Cells(HEADER_ROW, i).Value) = Year(dateAffaire) Then
                    Debug.Print "      >>> MATCH! On applique la couleur " & coulAffaire & " à (" & srcRow & "," & i & ")"
                    ws.Cells(srcRow, i).Interior.Color = coulAffaire
                    trouve = True
                    Exit For
                End If
            End If
        Next i
        If Not trouve Then
            Debug.Print ">>> Aucune colonne planning correspondante trouvée pour la date."
        End If
    Else
        Debug.Print ">>> La date à colorier n'est pas reconnue comme date."
    End If
End Sub



