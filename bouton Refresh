Sub Button1_Click()

    ' --- Constantes de configuration des feuilles et colonnes ---
    Const FEUILLE_AFFAIRES As String = "PLANNING AFFAIRES"
    Const FEUILLE_METRE As String = "PLANNING METRE ET GEOMETRE"
    Const COL_ID As Long = 286           ' Colonne contenant l'identifiant unique (JZ devient KA)
    Const COL_START As Long = 3          ' Début des colonnes à synchroniser (ex: colonne C)
    Const COL_END As Long = 22           ' Fin des colonnes à synchroniser (ex: colonne V)
    Const COL_DATE_Q As Long = 18        ' Colonne contenant la date (R)
    Const COL_COULEUR_Q As Long = 17     ' Colonne contenant la couleur liée à la date (Q)
    Const HEADER_ROW As Long = 5         ' Ligne d'en-tête dans le planning
    Const START_COL As Long = 23         ' Début des colonnes du planning (W)

    ' --- Initialisation des feuilles et dernière ligne ---
    Dim wsSrc As Worksheet: Set wsSrc = ThisWorkbook.Sheets(FEUILLE_AFFAIRES)
    Dim wsPMG As Worksheet: Set wsPMG = ThisWorkbook.Sheets(FEUILLE_METRE ET GEOMETRE)
    Dim lastRow As Long: lastRow = wsSrc.Cells(wsSrc.Rows.Count, COL_ID).End(xlUp).row

    Dim r As Long, c As Long
    Dim cellulesMaj As Long: cellulesMaj = 0

    ' --- Optimisation : désactive les événements et le rafraîchissement d'écran ---
    Application.EnableEvents = False
    Application.ScreenUpdating = False

    ' --- 1) Synchronisation des cellules entre feuilles ---
    ' Pour chaque ligne avec un identifiant, on copie les valeurs et les couleurs dans les autres feuilles
    For r = 5 To lastRow
        If wsSrc.Cells(r, COL_ID).Value <> "" Then
            For c = COL_START To COL_END
                Call Sheet1.SyncToOtherSheets(Sheet1.Cells(r, c), Sheet1, COL_ID)
                cellulesMaj = cellulesMaj + 1
            Next c
        Else
            Debug.Print "Ligne " & r & " : pas d'ID, ignorée."
        End If
    Next r

    ' --- 2) Mise à jour de la coloration des plannings ligne par ligne ---
    ' Appelle une fonction spécifique pour colorer la cellule correspondant à la date
    For r = 5 To lastRow
        If wsSrc.Cells(r, COL_ID).Value <> "" Then
            Sheet1.SynchroniseCasePlanning r
        End If
    Next r

    ' --- 3) Mise en surbrillance des lignes avec "exc" dans la colonne "coef" ---
    ' Si "exc" est détecté, on colore la cellule en jaune pâle (sur les deux feuilles)
    Dim wsAff As Worksheet
    Dim r2 As Long, lastRowAff As Long, lastRowPMG As Long

    Set wsAff = ThisWorkbook.Sheets(FEUILLE_AFFAIRES)
    lastRowAff = wsAff.Cells(wsAff.Rows.Count, COL_ID).End(xlUp).row
    For r2 = 5 To lastRowAff
        If LCase(wsAff.Cells(r2, 21).Value) = "exc" Then      ' Colonne U (index 21)
            wsAff.Cells(r2, 21).Interior.Color = RGB(255, 255, 153)
        End If
    Next r2

    lastRowPMG = wsPMG.Cells(wsPMG.Rows.Count, COL_ID).End(xlUp).row
    For r2 = 5 To lastRowPMG
        If LCase(wsPMG.Cells(r2, 23).Value) = "exc" Then      ' Colonne W (index 23)
            wsPMG.Cells(r2, 23).Interior.Color = RGB(255, 255, 153)
        End If
    Next r2

    ' --- 4) Coloration conditionnelle des cases du planning ---
    ' Pour chaque ligne avec une date en colonne R (dateQ) et une couleur en Q (coulQ),
    ' on applique la couleur sur la cellule correspondante du planning
    For r2 = 5 To lastRowPMG
        Dim dateQ As Variant, coulQ As Long
        dateQ = wsPMG.Cells(r2, COL_DATE_Q).Value
        coulQ = wsPMG.Cells(r2, COL_COULEUR_Q).Interior.Color
        If IsDate(dateQ) Then
            Sheet2.ColorieCaseQ wsPMG, r2, HEADER_ROW, START_COL, dateQ, coulQ
        Else
            ' Si aucune date : on efface la couleur de la cellule correspondante
            Sheet2.ColorieCaseQ wsPMG, r2, HEADER_ROW, START_COL, "", -1
        End If
    Next r2

    ' --- Réactivation des événements Excel et rafraîchissement visuel ---
    Application.EnableEvents = True
    Application.ScreenUpdating = True

    ' --- Message final ---
    MsgBox "Refresh terminé : " & cellulesMaj & " cellules synchronisées et plannings colorés.", vbInformation

End Sub
